# Пространственное соединение (Spatial Join)

## 1. Введение и теоретические основы

Пространственное соединение (англ. *spatial join*) представляет собой фундаментальную операцию векторного анализа, направленную на объединение атрибутивных таблиц двух геопространственных слоёв на основе их **пространственных отношений**. В отличие от табличного (реляционного) соединения, которое опирается на совпадение значений ключевых полей, пространственное соединение использует **топологические предикаты**, такие как пересечение, включение, близость или соприкосновение.

Формально, пространственное соединение можно определить как бинарную операцию над двумя множествами объектов \( A \) и \( B \), результатом которой является новое множество \( C \), где каждый объект \( c_i \in C \) содержит атрибуты из \( a_j \in A \) и \( b_k \in B \), если выполняется условие \( R(a_j, b_k) = \text{true} \). Здесь \( R \) — пространственный предикат, например:
- \( \text{Intersects}(a_j, b_k) \)
- \( \text{Within}(a_j, b_k) \)
- \( \text{Contains}(a_j, b_k) \)
- \( \text{Closest}(a_j, b_k) \)

В геоинформатике spatial join лежит в основе таких задач, как привязка точечных объектов к административным единицам, оценка попадания инфраструктурных объектов в зоны риска, агрегация статистики по территориям и моделирование пространственных взаимодействий. Метод соответствует принципам **интеграции разнородных данных** и является ключевым элементом подготовки данных для последующего анализа.

## 2. Ключевые слова и семантические триггеры

пространственное соединение, spatial join, привязка, пересечение, внутри, содержит, ближайший, атрибутивная таблица, топология, overlay, QGIS Join Attributes by Location, ArcMap Spatial Join

## 3. Область применения

- **Административно-территориальное деление**: привязка школ, больниц, предприятий к районам или муниципалитетам.
- **Экологический анализ**: определение количества жилых домов, попадающих в зону затопления.
- **Социальная статистика**: агрегация данных переписи населения по избирательным участкам.
- **Логистика**: назначение складов клиентам на основе ближайшего расположения.
- **Управление ЧС**: выявление объектов инфраструктуры, находящихся в радиусе поражения.
- **Кадастр**: установление принадлежности земельных участков к кварталам или зонам.

## 4. Входные данные

- **Целевой слой (Target)**: слой, к которому присоединяются атрибуты (обычно точки или полигоны).
- **Присоединяемый слой (Join)**: слой, откуда берутся атрибуты (обычно полигоны или точки).
- **Тип пространственного отношения**:
  - *Intersect* — объекты пересекаются,
  - *Within* — целевой объект полностью внутри присоединяемого,
  - *Contains* — присоединяемый объект внутри целевого,
  - *Closest* — ближайший объект (для точек),
  - *Have their center in* — центр целевого объекта внутри присоединяемого.
- **Система координат**: оба слоя должны быть в одной проекции (рекомендуется метрическая).

> ⚠️ **Важно**: При несовпадении CRS результат может быть некорректным. Перед выполнением операции необходимо убедиться в согласованности систем координат.

## 5. Выходные данные

- Новый векторный слой того же типа, что и **целевой слой**.
- Атрибутивная таблица содержит все поля из обоих исходных слоёв.
- Возможна агрегация (например, сумма, среднее, количество) при множественном соединении.
- Для точек, не имеющих соответствий, могут быть созданы записи с пустыми значениями (опция «Keep all records»).

## 6. Программная реализация

### 6.1. QGIS (версия 3.28+)
- **Путь**: Вектор → Инструменты исследования → Присоединить атрибуты по расположению...
- **Параметры**:
  - Target vector layer: целевой слой,
  - Join vector layer: присоединяемый слой,
  - Geometric predicate(s): выбор одного или нескольких предикатов,
  - Fields to add: можно выбрать подмножество полей,
  - Summary to calculate: при необходимости — агрегатные функции,
  - Keep matching records only: да/нет.
- **Особенности**: поддерживает множественные предикаты и агрегацию в одном шаге.

### 6.2. ArcMap (версии 10.4–10.8)

Инструмент **Spatial Join** в ArcMap является частью модуля *Analysis Tools* и широко используется в производственной практике благодаря своей надёжности и гибкости.

#### Доступ к инструменту:
1. Откройте **ArcToolbox**.
2. Перейдите: **Analysis Tools → Overlay → Spatial Join**.

#### Основные параметры:
- **Target Features**: слой, к которому присоединяются данные (например, точки школ).
- **Join Features**: слой-источник атрибутов (например, полигоны районов).
- **Output Feature Class**: путь к выходному файлу.
- **Join Operation**:
  - *JOIN_ONE_TO_ONE* — каждая запись целевого слоя получает атрибуты одного (или агрегированных) присоединяемого объекта,
  - *JOIN_ONE_TO_MANY* — создаётся отдельная запись для каждого совпадения (может сильно увеличить объём данных).
- **Match Option** (ключевой параметр):
  - *INTERSECT* — объекты пересекаются,
  - *WITHIN_A_DISTANCE* — в пределах заданного расстояния (требует указания радиуса),
  - *CONTAINS*, *WITHIN*, *CLOSEST* и др.
- **Search Radius**: задаётся только при *WITHIN_A_DISTANCE* (в единицах CRS).
- **Field Map of Join Features**: позволяет выбрать, какие поля переносить, и задать правила агрегации (Sum, Mean, Min, Max, Count и др.).

#### Особенности версий 10.4–10.8:
- В ArcMap 10.4–10.6 интерфейс Field Map менее интуитивен — рекомендуется сначала протестировать на небольшой выборке.
- Начиная с 10.7, улучшена обработка полей с NULL-значениями при агрегации.
- При работе с большими данными (>100 тыс. объектов) рекомендуется использовать **File Geodatabase** для повышения скорости и устойчивости.
- Инструмент **не создаёт новых геометрий** — выходной слой наследует геометрию целевого слоя.

#### Типичные сценарии:
- **Привязка точек к полигонам**:  
  Target = точки (школы), Join = полигоны (районы), Match Option = *WITHIN*.
- **Поиск ближайшего объекта**:  
  Target = дома, Join = школы, Match Option = *CLOSEST*, Search Radius = 2000 м.
- **Подсчёт объектов в зоне**:  
  Target = зоны затопления, Join = дома, Match Option = *INTERSECT*, Join Operation = *JOIN_ONE_TO_ONE*, агрегация по полю *Count*.

## 7. Примеры формулировок пользовательских запросов

- «Как привязать все школы к административным районам?»
- «Сколько жилых домов попадает в зону возможного затопления?»
- «Найти ближайшую аптеку к каждому дому»
- «Добавить в таблицу дорог информацию о районах, через которые они проходят»
- «Посчитать количество предприятий в каждом квартале»

## 8. Ограничения и особенности

1. **Производительность**: при JOIN_ONE_TO_MANY и большом числе пересечений объём данных может вырасти экспоненциально.
2. **Неоднозначность**: один объект может пересекаться с несколькими — требуется чёткое определение бизнес-логики (брать первый, ближайший, все?).
3. **Точность геометрии**: ошибки топологии (самопересечения, щели) могут привести к пропуску совпадений.
4. **Отсутствие семантики**: система не понимает, *почему* объекты связаны — только *как*.
5. **Ограничения ArcMap**: в версиях до 10.7 отсутствует предикат *HAVE_THEIR_CENTER_IN*, который есть в QGIS.

## 9. Научно-методическое обоснование

Пространственное соединение реализует концепцию **пространственной зависимости** и является практическим инструментом для проверки гипотез о территориальной принадлежности. В учебниках по ГИС (например, de Smith et al., *Geospatial Analysis*, 2018) spatial join рассматривается как базовая операция overlay-анализа и обязательный этап подготовки данных для картографического моделирования.

## 10. Литература и нормативные источники

- de Smith M. J., Goodchild M. F., Longley P. A. *Geospatial Analysis: A Comprehensive Guide*. — 6th ed. — Locate Press, 2018.
- ISO 19107:2003. *Geographic information — Spatial schema*.
- QGIS Documentation. *Join attributes by location*. URL: https://docs.qgis.org
- Esri. *Spatial Join (Analysis)*. ArcGIS Desktop Help (версии 10.4–10.8). URL: https://desktop.arcgis.com
