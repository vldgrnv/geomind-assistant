# Объединение (Merge) пространственных слоёв

## 1. Введение и теоретические основы

Объединение (англ. *merge*) — это фундаментальная операция векторной геообработки, направленная на **консолидацию нескольких однотипных векторных слоёв** (точечных, линейных или полигональных) в единый выходной слой без изменения геометрии исходных объектов. С геометрической точки зрения, merge представляет собой объединение множеств объектов \( A_1, A_2, ..., A_n \) в новое множество \( A_{\text{merged}} = \bigcup_{i=1}^{n} A_i \), при этом каждый объект сохраняет свою исходную форму и атрибутивные данные.

В контексте геоинформационных систем данная операция служит инструментом **агрегации разрозненных данных**, полученных из различных источников, но относящихся к одной тематической категории. Merge позволяет преодолеть фрагментацию геопространственной информации, возникающую при сборе данных по отдельным районам, периодам или ведомствам, и создать единый аналитический набор для последующего моделирования. Операция широко применяется при подготовке данных для картографического обобщения, статистического анализа и мониторинга динамики территориальных процессов.

Методологически объединение относится к классу **операций над метаданными** и не затрагивает топологию объектов. В отличие от *dissolve* или *clip*, merge **не изменяет геометрию**, а лишь конкатенирует записи из нескольких таблиц, унифицируя структуру атрибутивных полей. Это делает его незаменимым этапом в пайплайнах обработки данных, где требуется объединение результатов полевых работ, интеграция открытых данных или агрегация исторических записей.

## 2. Ключевые слова и семантические триггеры

объединение, merge, слияние слоёв, консолидация, агрегация данных, QGIS Merge Vector Layers, ArcMap Merge

## 3. Область применения

- **Кадастр и землеустройство**: объединение участков, собранных по отдельным муниципалитетам, в единый региональный слой.
- **Экологический мониторинг**: агрегация данных о состоянии лесов, полученных от разных лесничеств.
- **Градостроительство**: консолидация планов застройки по микрорайонам в единый городской план.
- **Транспортная аналитика**: объединение дорожных сетей, собранных по отдельным трассам или регионам.
- **Социальная статистика**: агрегация переписей населения по годам или административным единицам.
- **Управление ЧС**: интеграция данных о повреждённых объектах, собранных разными бригадами.

## 4. Входные данные

- **Несколько векторных слоёв одного типа геометрии** (все — точки, все — линии или все — полигоны).
- **Совместимость атрибутивных структур**: поля с одинаковыми названиями должны иметь совместимые типы данных.
- **Единая система координат** (рекомендуется, но не обязательна — большинство ГИС выполняют on-the-fly репроецирование).
- **Отсутствие дублирующих объектов** (если дубли нежелательны — требуется последующая очистка).

> ⚠️ **Важно**: Если структуры атрибутивных таблиц различаются, система автоматически создаёт **объединённую схему**, включающую все поля из всех входных слоёв. Отсутствующие значения заполняются как NULL.

## 5. Выходные данные

- Новый векторный слой того же типа геометрии, что и входные.
- Атрибутивная таблица содержит **все поля** из всех входных слоёв.
- Каждый объект сохраняет свою исходную геометрию и атрибуты.
- Дополнительно может быть добавлено служебное поле (например, `source_layer`), указывающее, из какого исходного слоя взят объект.

## 6. Программная реализация

### 6.1. QGIS (версия 3.28+)
- **Путь**: Обработка → Инструменты анализа → Объединить векторные слои...
- **Параметры**:
  - Input layers: список слоёв для объединения,
  - Destination CRS: система координат выходного слоя,
  - Output file: путь к выходному файлу.
- **Особенности**: 
  - Автоматически создаёт объединённую схему полей,
  - Поддерживает смешанные источники (shapefile, GeoPackage, базы данных),
  - Может добавлять поле `layer_name` для отслеживания источника.

### 6.2. ArcMap 

Инструмент **Merge** входит в состав модуля **Data Management Tools** и является ключевым элементом в производственных пайплайнах обработки данных.

#### Доступ к инструменту:
1. Откройте **ArcToolbox**.
2. Перейдите: **Data Management Tools → General → Merge**.

#### Основные параметры:
- **Input Datasets**: список слоёв или feature classes для объединения.
- **Output Dataset**: путь к выходному файлу (shapefile или feature class в geodatabase).
- **Field Map**: интерфейс для управления объединением атрибутивных полей:
  - Можно выбрать, какие поля включать в результат,
  - Указать правила обработки конфликтов (например, при разных типах данных),
  - Задать постоянные значения для отсутствующих полей.

#### Особенности версий 10.4–10.8:
- В ArcMap 10.4–10.6 интерфейс **Field Map** может быть сложным для новичков — рекомендуется использовать «автоматическое сопоставление» (Auto Match).
- Начиная с 10.7, улучшена обработка полей с NULL-значениями и несовпадающими типами.
- При работе с большим числом слоёв (>10) рекомендуется использовать **File Geodatabase** для повышения скорости.
- Инструмент **сохраняет все исходные геометрии без изменений** — это гарантирует целостность данных.

#### Типичные сценарии:
- **Агрегация кадастра**:  
  Input = участки_район1.shp, участки_район2.shp → Output = участки_регион.shp
- **Объединение дорожных сетей**:  
  Input = дороги_город.shp, дороги_пригород.shp → Output = дороги_агломерация.shp
- **Интеграция экологических данных**:  
  Input = леса_2020.shp, леса_2021.shp → Output = леса_динамика.shp

## 7. Примеры формулировок пользовательских запросов

- «Как объединить несколько shapefile с участками в один слой?»
- «Нужно слить дорожные сети из трёх районов в одну»
- «Объедини все слои школ по годам в один файл»
- «Как в QGIS сделать merge нескольких векторных слоёв?»
- «Слияние данных из разных источников в ArcMap»

## 8. Ограничения и особенности

1. **Требование к типу геометрии**: все входные слои **должны быть одного типа** (только точки, только линии или только полигоны). Попытка объединить разные типы приведёт к ошибке.
2. **Разрастание атрибутивной таблицы**: при большом числе входных слоёв с разными полями выходная таблица может содержать десятки столбцов, многие из которых будут заполнены NULL.
3. **Потеря контекста источника**: без дополнительного поля (`source_layer`) невозможно определить, из какого исходного слоя взят объект.
4. **Производительность**: при объединении большого числа объектов (>100 тыс.) время выполнения может достигать нескольких минут.
5. **Ограничения ArcMap**: в версиях до 10.7 отсутствует опция автоматического добавления поля-источника (в отличие от QGIS).

## 9. Научно-методическое обоснование

Объединение слоёв является базовым элементом **подготовки данных для пространственного анализа** и соответствует принципу **интероперабельности геоинформационных систем**. В учебниках по ГИС (например, Longley et al., *Geographic Information Science & Systems*, 2015) merge рассматривается как обязательный этап в пайплайнах обработки данных, обеспечивающий целостность и полноту аналитической выборки.

## 10. Литература и нормативные источники

- Longley P. A., Goodchild M. F., Maguire D. J., Rhind D. W. *Geographic Information Science & Systems*. — 4th ed. — Wiley, 2015.
- ISO 19107:2003. *Geographic information — Spatial schema*.
- QGIS Documentation. *Merge Vector Layers*. URL: https://docs.qgis.org
- Esri. *Merge (Data Management)*. ArcGIS Desktop Help (версии 10.4–10.8). URL: https://desktop.arcgis.com
